name: Acceptance Test

on:
  # Allow testing on pull requests from forks, only when a label named "acceptance test" is applied.
  pull_request_target:
    types:
      - labeled

permissions:
    contents: read

jobs:
  # Run acceptance tests in a matrix with Terraform CLI versions
  test:
    name: Terraform Provider Acceptance Tests
    runs-on: ubuntu-latest
    # Run acceptance test only when the label "acceptance test" is applied.
    if: contains(github.event.pull_request.labels.*.name, 'acceptance test')
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        # list whatever Terraform versions here you would like to support
        terraform:
          - '1.0.*'
          - '1.1.*'
          - '1.2.*'
          - '1.3.*'
          - '1.4.*'
    steps:
      - uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608 # v4.1.0
      - uses: actions/setup-go@93397bea11091df50f3d7e59dc26a7711a8bcfbe # v4.1.0
        with:
          go-version-file: 'go.mod'
          cache: true
      - uses: hashicorp/setup-terraform@633666f66e0061ca3b725c73b2ec20cd13a8fdd1 # v2.0.3
        with:
          terraform_version: ${{ matrix.terraform }}
          terraform_wrapper: false
      - run: go mod download
      - env:
          TF_ACC: "1"
          DENO_DEPLOY_ORGANIZATION_ID: "6a3ce81a-7ae8-4e72-ad2d-3eb4f723693b"
          DEPLOY_API_HOST: "https://api.deno-staging.com/v1"
          DENO_DEPLOY_TOKEN: ${{ secrets.DENO_DEPLOY_TOKEN }}
        run: go test -v -cover ./internal/provider/
        timeout-minutes: 10
